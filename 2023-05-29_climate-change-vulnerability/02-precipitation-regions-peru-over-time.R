library(tidyverse)
library(sf)
library(patchwork)

peru <- readRDS("common-data/gadm/gadm41_PER_1_pk.rds") %>%
  st_as_sf() %>%
  mutate( # to prepare for merging Lima and Lima Province
    region = if_else(
      NAME_1 %in% c("Lima", "Lima Province"),
      "Lima",
      NAME_1
    ) %>%
      str_to_upper()
  ) %>%
  group_by(region) %>%
  summarise() %>%
  ungroup()

region_df <- regions_annual_rain_df %>%
  mutate(
    period = paste0("p_", period) %>%
      str_replace("-", "_")
  ) %>%
  pivot_wider(
    names_from = period,
    values_from = annual
  ) %>%
  mutate(
    pct_d1 = (p_1931_1960 - p_1901_1930) / p_1901_1930,
    pct_d2 = (p_1961_1990 - p_1901_1930) / p_1901_1930,
    pct_d3 = (p_1991_2020 - p_1901_1930) / p_1901_1930
  ) %>%
  select(
    region, pct_d1, pct_d2, pct_d3
  ) %>%
  pivot_longer(
    cols = 2:4,
    names_to = "periods",
    values_to = "pct_change"
  ) %>%
  mutate(
    periods = case_match(
      periods,
      "pct_d1" ~ "Between [1901-1930] and [1931-1960]",
      "pct_d2" ~ "Between [1901-1930] and [1961-1990]",
      "pct_d3" ~ "Between [1901-1930] and [1991-2020]"
    )
  )

map_df <- peru %>%
  left_join(
    region_df,
    by = "region"
  )


chg_precipitation_maps <- ggplot(map_df) +
  geom_sf(aes(fill = pct_change)) +
  scale_fill_distiller(
    name = "",
    type = "div", palette = "PuOr", direction = 1,
    labels = scales::label_percent()
  ) +
  facet_wrap(~periods) +
  labs(
    title = "Changes in annual precipitation in the regions of Peru",
    subtitle = "Data source: World Bank Climate Change Knowledge Portal",
    caption = "#MapPromptMonday, 2023-05-29 // Jesus M. Castagnetto - @jmcastagnetto@mastodon.social",
  ) +
  theme_void(
    base_size = 18,
    base_family = "Atkinson Hyperlegible"
  ) +
  theme(
    plot.margin = unit(rep(1, 4), "cm"),
    strip.background = element_rect(fill = "peru", color = "peru"),
    strip.text = element_text(color = "white", face = "bold", margin = margin(6, 0, 6, 0, "pt")),
    legend.key.height = unit(1.5, "cm"),
    plot.caption = element_text(family = "Inconsolata", size = 16),
    plot.subtitle = element_text(size = 20, color = "grey40"),
    plot.title = element_text(size = 28, face = "bold"),
    plot.background = element_rect(fill = "white", color = "white")
  )

ggsave(
  plot = chg_precipitation_maps,
  filename = "2023-05-29_climate-change-vulnerability/peru-regions-change-precipitation.png",
  width = 14,
  height = 8
)
